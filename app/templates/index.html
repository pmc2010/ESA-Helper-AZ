<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESA Helper - ClassWallet Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <strong>ESA Helper</strong>
                <span class="navbar-text text-light" style="font-size: 0.9rem; margin-left: 0.5rem;">ClassWallet Automation</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Submit Request</a>
                    </li>
                    {% include '_settings_dropdown.html' %}
                    {% include '_help_dropdown.html' %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Credentials Alert -->
        <div id="credentialsAlert" class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Setup Required:</strong> Please configure your ClassWallet credentials.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            <button type="button" class="btn btn-sm btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#credentialsModal">
                Configure Credentials
            </button>
        </div>

        <div class="row">
            <div class="col-lg-7 offset-lg-1">
                <form id="reimbursementForm">
                    <!-- Student Selection -->
                    <div class="card mb-4 border-start border-primary border-5">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <span class="badge bg-primary me-2">Step 1</span>
                                Basic Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="student" class="form-label">
                                        Student <span class="text-danger">*</span>
                                        <span class="badge bg-light text-dark ms-1" data-bs-toggle="tooltip" title="Which child is this reimbursement for?">?</span>
                                    </label>
                                    <select class="form-select" id="student" name="student" required>
                                        <option value="">-- Select Student --</option>
                                        {% for student in students %}
                                        <option value="{{ student.id }}">{{ student.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted d-block mt-2">
                                        Select which of your children this payment is for.
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="template" class="form-label">
                                        Template
                                        <span class="badge bg-info text-dark ms-1">Optional</span>
                                    </label>
                                    <select class="form-select" id="template" name="template">
                                        <option value="">-- No Template --</option>
                                        <optgroup label="Recent Templates">
                                        </optgroup>
                                    </select>
                                    <small class="form-text text-muted d-block mt-2">
                                        üí° Tip: Use templates for recurring activities (e.g., weekly lessons). They auto-fill most fields.
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="requestType" class="form-label">
                                        Request Type <span class="text-danger">*</span>
                                        <span class="badge bg-light text-dark ms-1" data-bs-toggle="tooltip" title="Reimbursement: You paid, getting money back. Direct Pay: Vendor gets paid directly.">?</span>
                                    </label>
                                    <select class="form-select" id="requestType" name="request_type" required>
                                        <option value="">-- Select Type --</option>
                                        <option value="Reimbursement">Reimbursement (You paid with your own money)</option>
                                        <option value="Direct Pay">Direct Pay (ClassWallet pays vendor directly)</option>
                                    </select>
                                    <small class="form-text text-muted d-block mt-2">
                                        <strong>Reimbursement:</strong> You paid the teacher/vendor with your own money and want ClassWallet to pay you back.<br>
                                        <strong>Direct Pay:</strong> ClassWallet sends money directly to a pre-approved vendor (less common).
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="storeName" class="form-label">
                                        Store/Vendor Name <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="storeName" name="store_name" required placeholder="e.g., Ice Skating Rink, Horseback Riding, Target, Amazon">
                                    <small class="form-text text-muted d-block mt-2">
                                        Enter the name of the person or business you paid. Use the person's name if paying an instructor.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Direct Pay Vendor Selection (Hidden by default) -->
                    <div id="directPayCard" class="card mb-4" style="display: none;">
                        <div class="card-header">
                            <h5>Vendor Selection (Direct Pay)</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="vendorSelect" class="form-label">Pre-Approved Vendor <span class="text-danger">*</span></label>
                                <select class="form-select" id="vendorSelect" name="vendor_select">
                                    <option value="">Search or select vendor...</option>
                                </select>
                            </div>

                            <div class="mb-3" id="searchTermContainer" style="display: none;">
                                <label for="classwalletSearchTermDisplay" class="form-label">
                                    ClassWallet Search Term
                                </label>
                                <input type="text" class="form-control" id="classwalletSearchTermDisplay" readonly>
                                <small class="form-text text-muted d-block mt-2">
                                    This exact term will be used to search for the vendor in ClassWallet.
                                    <a href="/manage-vendors">Edit the vendor</a> to change this value.
                                </small>
                            </div>

                            <div class="alert alert-warning mb-3" id="missingSearchTermWarning" style="display: none;" role="alert">
                                <strong>‚ö†Ô∏è Configuration Required</strong><br>
                                <small class="d-block mt-2">
                                    This vendor does not have a ClassWallet Search Term configured. Direct Pay automation requires an exact search term to locate the vendor.
                                </small>
                                <div class="mt-3">
                                    <a href="/manage-vendors" class="btn btn-sm btn-warning">Configure Vendor</a>
                                </div>
                            </div>

                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addVendorModal">
                                + Add New Vendor
                            </button>
                        </div>
                    </div>

                    <!-- Amount & Expense Category -->
                    <div class="card mb-4 border-start border-success border-5">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <span class="badge bg-success me-2">Step 2</span>
                                Amount & Category
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="amount" class="form-label">
                                        Amount <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0" value="0" required placeholder="0.00">
                                    </div>
                                    <small class="form-text text-muted d-block mt-2">
                                        Enter the amount you paid. Include cents if applicable (e.g., 45.50).
                                    </small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="expenseCategory" class="form-label">
                                        Expense Category <span class="text-danger">*</span>
                                        <span class="badge bg-light text-dark ms-1" data-bs-toggle="tooltip" title="Choose the category that best matches this expense">?</span>
                                    </label>
                                    <select class="form-select" id="expenseCategory" name="expense_category" required>
                                        <option value="">-- Select Category --</option>
                                        {% for category in expense_categories %}
                                        <option value="{{ category }}">{{ category }}</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted d-block mt-2">
                                        ClassWallet requires you to categorize the expense. This helps classify different types of educational spending.
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Generation (Optional) -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>Invoice Generation <span class="badge bg-info">Optional</span></h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="generateInvoice" name="generate_invoice">
                                <label class="form-check-label" for="generateInvoice">
                                    Generate invoice for this transaction
                                </label>
                            </div>
                            <div id="invoiceSection" style="display: none;">
                                <p class="text-muted small mb-3">Automatically generate an Excel and PDF invoice based on vendor and student information.</p>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="invoiceVendor" class="form-label">Vendor Name</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="invoiceVendor" placeholder="Auto-filled from Store/Vendor Name">
                                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#editVendorModal">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="invoiceStudent" class="form-label">Student Name</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="invoiceStudent" placeholder="Auto-filled from Student">
                                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#editStudentModal">
                                                Edit
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="invoiceNumber" class="form-label">Invoice Number</label>
                                        <input type="text" class="form-control" id="invoiceNumber" placeholder="e.g., 20251103_1230">
                                        <small class="form-text text-muted">Default: PO Number (can override)</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="invoiceDate" class="form-label">Invoice Date</label>
                                        <input type="date" class="form-control" id="invoiceDate">
                                        <small class="form-text text-muted">Default: Today's date</small>
                                    </div>
                                </div>

                                <!-- Multiple Line Items -->
                                <div class="mb-3">
                                    <label class="form-label d-block mb-2">Line Items</label>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Description</th>
                                                    <th style="width: 80px;">Qty</th>
                                                    <th style="width: 100px;">Unit Price</th>
                                                    <th style="width: 100px;">Total</th>
                                                    <th style="width: 40px;"></th>
                                                </tr>
                                            </thead>
                                            <tbody id="invoiceLineItems">
                                                <tr class="line-item-row">
                                                    <td><input type="text" class="form-control form-control-sm line-description" placeholder="e.g., Ice skating lesson"></td>
                                                    <td><input type="number" class="form-control form-control-sm line-quantity" value="1" min="1" step="1"></td>
                                                    <td><input type="number" class="form-control form-control-sm line-unit-price" step="0.01" min="0"></td>
                                                    <td><input type="number" class="form-control form-control-sm line-total" readonly style="background-color: #f0f0f0;"></td>
                                                    <td><button type="button" class="btn btn-sm btn-outline-danger remove-line-item" onclick="removeLineItem(this)">√ó</button></td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addLineItem()">+ Add Line Item</button>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <p class="mb-2"><strong>Subtotal:</strong> $<span id="subtotalAmount">0.00</span></p>
                                                <p class="mb-2">
                                                    <strong>Tax Rate (%):</strong>
                                                    <input type="number" class="form-control form-control-sm d-inline-block" style="width: 80px;" id="invoiceTaxRate" value="0" step="0.01" min="0" max="100" onchange="updateInvoiceTotals()">
                                                </p>
                                                <p class="mb-0"><strong>Tax:</strong> $<span id="taxAmount">0.00</span></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body">
                                                <h5 class="card-title mb-3">Total Due</h5>
                                                <h3 style="font-size: 2em;">$<span id="totalAmount">0.00</span></h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-success" id="generateInvoiceBtn">
                                    Generate Invoice
                                </button>
                                <div id="invoiceStatus" style="display: none; margin-top: 15px;" class="alert alert-info"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic File Upload Based on Category -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Required Documents</h5>
                        </div>
                        <div class="card-body" id="fileUploadContainer">
                            <p class="text-muted">Select an expense category to see required documents</p>
                        </div>
                        <!-- Selected Files Summary -->
                        <div id="selectedFilesSummary" style="display: none; border-top: 1px solid #dee2e6; padding-top: 1rem;">
                            <h6 class="mb-2">Selected Files:</h6>
                            <div id="selectedFilesDisplay"></div>
                        </div>
                    </div>

                    <!-- PO Number & Comment -->
                    <div class="card mb-4 border-start border-warning border-5">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <span class="badge bg-warning text-dark me-2">Step 3</span>
                                Purchase Order & Notes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="poNumber" class="form-label">
                                        PO Number <span class="text-danger">*</span>
                                        <span class="badge bg-light text-dark ms-1" data-bs-toggle="tooltip" title="A unique identifier for this transaction. Auto-generated from today's date and time.">?</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="poNumber" name="po_number" required readonly placeholder="YYYYMMDD_HHMM">
                                        <button class="btn btn-outline-secondary" type="button" id="generatePoBtn">Generate</button>
                                    </div>
                                    <small class="form-text text-muted d-block mt-2">
                                        Click "Generate" to create a unique number (auto-generated from today's date and time). Format: YYYYMMDD_HHMM (e.g., 20251103_1430)
                                    </small>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="form-label">
                                    Comment <span class="text-danger">*</span>
                                    <span class="badge bg-light text-dark ms-1" data-bs-toggle="tooltip" title="A brief note about what this payment was for">?</span>
                                </label>
                                <input type="text" class="form-control" id="comment" name="comment" required placeholder="e.g., Ice skating lesson - 2025-11-03">
                                <small class="form-text text-muted d-block mt-2">
                                    Briefly describe the transaction. Include the activity name and date. This helps you remember what the payment was for later.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2 mb-4">
                        <button type="button" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="bi bi-upload"></i> Review & Submit
                        </button>
                        <button type="reset" class="btn btn-outline-secondary btn-lg" id="clearBtn">
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>

            <!-- Recent Submissions Sidebar -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 80px;">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">üìã Recent Submissions</h6>
                    </div>
                    <div class="card-body p-0">
                        <div id="recentSubmissionsList" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                            <div class="p-3 text-center text-muted">
                                <small>Loading submissions...</small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <a href="/submission-history" class="btn btn-sm btn-outline-primary w-100">
                            View All Submissions
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credentials Modal -->
    <div class="modal fade" id="credentialsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configure ClassWallet Credentials</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="credentialsForm">
                        <div class="mb-3">
                            <label for="email" class="form-label">ClassWallet Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">ClassWallet Password</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="alert alert-info">
                            <small>Note: Credentials are stored locally in plain text. This tool is for local use only.</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveCredentialsBtn">Save Credentials</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Vendor Modal -->
    <div class="modal fade" id="addVendorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Vendor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addVendorForm">
                        <div class="mb-3">
                            <label for="vendorName" class="form-label">Vendor Name</label>
                            <input type="text" class="form-control" id="vendorName" name="vendor_name" required placeholder="e.g., Alta Climbing Gym LLC">
                        </div>
                        <div class="mb-3">
                            <label for="vendorLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="vendorLocation" name="vendor_location" placeholder="e.g., AZ, Gilbert">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVendorBtn">Add Vendor</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vendor Modal (for Invoice) -->
    <div class="modal fade" id="editVendorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vendor Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVendorForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVendorName" class="form-label">Vendor Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editVendorName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorBusinessName" class="form-label">Business Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editVendorBusinessName" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editVendorAddress1" class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editVendorAddress1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editVendorAddress2" class="form-label">Address Line 2 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editVendorAddress2" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editVendorPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="editVendorPhone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editVendorEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editVendorEmail">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editVendorTaxRate" class="form-label">Tax Rate (%) (default for this vendor)</label>
                            <input type="number" class="form-control" id="editVendorTaxRate" value="0" step="0.01" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="saveVendorProfileBtn">Save Profile (Permanent)</button>
                    <button type="button" class="btn btn-primary" id="applyVendorBtn" data-bs-dismiss="modal">Apply (This Invoice)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal (for Invoice) -->
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Student Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <div class="mb-3">
                            <label for="editStudentName" class="form-label">Student Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editStudentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAddress1" class="form-label">Address Line 1 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editStudentAddress1" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStudentAddress2" class="form-label">Address Line 2 (City, State ZIP) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editStudentAddress2" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-primary" id="saveStudentProfileBtn">Save Profile (Permanent)</button>
                    <button type="button" class="btn btn-primary" id="applyStudentBtn" data-bs-dismiss="modal">Apply (This Invoice)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Generated Successfully</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="invoicePreviewContent">
                        <!-- Dynamically populated with invoice summary -->
                    </div>
                    <hr>
                    <div class="alert alert-info">
                        <strong>Files Generated:</strong>
                        <ul class="mb-0">
                            <li id="excelPathInfo">Excel: <code id="excelPath"></code></li>
                            <li id="pdfPathInfo" style="display: none;">PDF: <code id="pdfPath"></code></li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="continueInvoiceBtn" data-bs-dismiss="modal">Continue to File Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="fileBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Current Path:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="currentPath" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="goUpBtn">Go Up</button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">or enter path:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="pathInput" placeholder="/Volumes/...">
                            <button class="btn btn-outline-secondary" type="button" id="navigateBtn">Navigate</button>
                        </div>
                    </div>
                    <hr>
                    <div id="fileList" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                        <p class="text-muted">Loading...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Submission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmationContent">
                    <!-- Dynamically populated -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success btn-lg" id="confirmSubmitBtn">Submit to ClassWallet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Submission Successful</h5>
                </div>
                <div class="modal-body">
                    <p>Your reimbursement/direct pay request has been submitted successfully!</p>
                    <p><strong>PO Number:</strong> <span id="successPoNumber"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help & Instructions Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">üìñ Help & Instructions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-4" id="helpTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="quickstart-tab" data-bs-toggle="tab" data-bs-target="#quickstart" type="button">Quick Start</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="terminology-tab" data-bs-toggle="tab" data-bs-target="#terminology" type="button">Terminology</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tips-tab" data-bs-toggle="tab" data-bs-target="#tips" type="button">Tips & Tricks</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="faq-tab" data-bs-toggle="tab" data-bs-target="#faq" type="button">FAQ</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="helpTabContent">
                        <!-- Quick Start Tab -->
                        <div class="tab-pane fade show active" id="quickstart" role="tabpanel">
                            <h6>How to Submit a Reimbursement</h6>
                            <ol>
                                <li><strong>Select Student:</strong> Choose which child this payment is for</li>
                                <li><strong>Choose Payment Type:</strong> Select "Reimbursement" (you paid) or "Direct Pay" (vendor gets paid directly)</li>
                                <li><strong>Enter Vendor Name:</strong> Who did you pay? (e.g., teacher name, store name)</li>
                                <li><strong>Enter Amount:</strong> How much did you pay? (e.g., 45.50)</li>
                                <li><strong>Select Category:</strong> What type of expense? (e.g., Tutoring, Curriculum, etc.)</li>
                                <li><strong>Select Documents:</strong> Upload required files (receipt, invoice, attestation, etc.)</li>
                                <li><strong>Generate PO Number:</strong> Click "Generate" button to create a unique ID</li>
                                <li><strong>Add Comment:</strong> Briefly describe what this payment was for</li>
                                <li><strong>Review & Submit:</strong> Check your information and click submit</li>
                            </ol>

                            <div class="alert alert-info mt-3">
                                <strong>üí° Pro Tip:</strong> Use templates for recurring activities! If you regularly pay the same instructor, save it as a template to auto-fill most fields next time.
                            </div>
                        </div>

                        <!-- Terminology Tab -->
                        <div class="tab-pane fade" id="terminology" role="tabpanel">
                            <h6>Important Terms Explained</h6>

                            <div class="mb-3">
                                <strong>Reimbursement:</strong><br>
                                <small>You pay the vendor with your own money (check, cash, Venmo, etc.), then ClassWallet pays you back. Most common type.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Direct Pay:</strong><br>
                                <small>ClassWallet pays the vendor directly from your student's account. Less common, requires vendor to be on ClassWallet's approved list.</small>
                            </div>

                            <div class="mb-3">
                                <strong>PO Number:</strong><br>
                                <small>A unique identifier for this transaction. Think of it like a receipt number. Format: YYYYMMDD_HHMM (today's date + time).</small>
                            </div>

                            <div class="mb-3">
                                <strong>Expense Category:</strong><br>
                                <small>How you classify the spending (e.g., "Tutoring", "Curriculum", "Technology"). ClassWallet requires this for tracking.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Required Documents:</strong><br>
                                <small>Proof that you made the purchase. Usually: Receipt (proof of payment), Invoice (from vendor), Attestation (instructor confirms service).</small>
                            </div>

                            <div class="mb-3">
                                <strong>Template:</strong><br>
                                <small>A saved form for recurring expenses. Save once, auto-fill next time. Great for weekly lessons or monthly subscriptions.</small>
                            </div>
                        </div>

                        <!-- Tips & Tricks Tab -->
                        <div class="tab-pane fade" id="tips" role="tabpanel">
                            <h6>üí° Tips to Make This Easier</h6>

                            <div class="mb-3">
                                <strong>1. Use Templates for Recurring Activities</strong><br>
                                <small>Do you pay the same instructor weekly? Save it as a template. You'll just need to change the date and PO number next time.</small>
                            </div>

                            <div class="mb-3">
                                <strong>2. Take Screenshots When You Pay</strong><br>
                                <small>If paying via Venmo/PayPal/text transfer, take a screenshot right away. This is your proof of payment.</small>
                            </div>

                            <div class="mb-3">
                                <strong>3. Get an Invoice from the Vendor</strong><br>
                                <small>Ask instructors/vendors for an invoice or receipt. Most people are happy to provide one. We can even auto-generate invoices for you!</small>
                            </div>

                            <div class="mb-3">
                                <strong>4. Ask for Attestation from Instructors</strong><br>
                                <small>For tutoring/coaching, ask the instructor to sign a simple form confirming they provided the service. ClassWallet usually requires this.</small>
                            </div>

                            <div class="mb-3">
                                <strong>5. Use Descriptive Comments</strong><br>
                                <small>Instead of just "lesson", write "Ice skating lesson - Nov 3, 2025". This helps you remember what it was for later.</small>
                            </div>

                            <div class="mb-3">
                                <strong>6. Keep Organized Files</strong><br>
                                <small>Your files are automatically saved by student and year. Keep them organized! Delete duplicates.</small>
                            </div>
                        </div>

                        <!-- FAQ Tab -->
                        <div class="tab-pane fade" id="faq" role="tabpanel">
                            <h6 class="mb-3">Frequently Asked Questions</h6>

                            <div class="mb-3">
                                <strong>Q: What if I don't have all the documents?</strong><br>
                                <small>A: You need at least a receipt (proof of payment). Invoice and Attestation depend on the expense type. See Required Documents section in the form.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: Can I submit multiple expenses at once?</strong><br>
                                <small>A: No, each expense gets its own submission with its own PO number. But if you use templates, it's fast!</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: What if I made a mistake?</strong><br>
                                <small>A: It's okay! You can go back and re-submit. ClassWallet is usually forgiving about minor corrections.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: How long does it take to get reimbursed?</strong><br>
                                <small>A: That depends on ClassWallet's processing time, usually 5-10 business days. This tool just helps you submit faster.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: Can I use this for multiple students?</strong><br>
                                <small>A: Yes! Select the student at the top of the form. Each child has their own ESA account and submissions.</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: What's the invoice generation feature?</strong><br>
                                <small>A: Optional feature that auto-creates professional Excel and PDF invoices for you. Check the "Generate invoice" checkbox to enable it. Saves time!</small>
                            </div>

                            <div class="mb-3">
                                <strong>Q: Do I need to be tech-savvy to use this?</strong><br>
                                <small>A: No! Just fill in the form fields and click buttons. The tool handles all the hard stuff automatically.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got It, Let's Go!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Splitter Modal -->
    <div class="modal fade" id="pdfSplitterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Split Multi-Page PDF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Upload a multi-page PDF and automatically split it into individual pages. This is useful when you have a single PDF file containing receipt, invoice, and attestation.
                    </p>

                    <!-- Upload Section -->
                    <div id="uploadSection">
                        <div class="mb-3">
                            <label for="pdfFileInput" class="form-label">Select PDF File</label>
                            <input type="file" class="form-control" id="pdfFileInput" accept=".pdf" />
                            <small class="form-text text-muted d-block mt-2">
                                Choose a PDF file from your computer. Files are processed locally.
                            </small>
                        </div>
                        <button type="button" class="btn btn-primary" id="uploadPdfBtn" onclick="uploadAndSplitPdf()">
                            üì§ Upload & Split PDF
                        </button>
                        <div id="uploadStatus" style="display: none; margin-top: 15px;"></div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" style="display: none;">
                        <div class="alert alert-success mb-3">
                            ‚úì PDF split successfully! <span id="splitCount"></span>
                        </div>

                        <h6 class="mb-3">Select pages to include:</h6>
                        <p class="text-muted small mb-3">Check the pages you want to add to your submission.</p>
                        <div id="splitFilesList" class="mb-3">
                            <!-- Split files will be listed here -->
                        </div>

                        <div class="alert alert-info">
                            <small>Selected pages will be added to your submission. You can manage all temporary files in <a href="/manage-temp-files" target="_blank">Manage Temporary Files</a>.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="closePdfSplitterBtn">Close</button>
                    <button type="button" class="btn btn-success" id="addSelectedSplitFilesBtn" style="display: none;" onclick="addSelectedSplitFilesToForm()">
                        ‚úì Add Selected Files to Form
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Details Modal -->
    <div class="modal fade" id="submissionDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Submission Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="submissionDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal for displaying submission errors -->
    <div class="modal fade" id="errorModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-circle me-2"></i>Submission Error
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Error Message -->
                    <div class="alert alert-danger mb-3" role="alert">
                        <strong>What happened:</strong><br>
                        <p id="errorMessage" class="mb-0 mt-2"></p>
                    </div>

                    <!-- Error Details/Suggestions -->
                    <div id="errorDetails" class="mb-3">
                        <h6 class="mb-2">What you can try:</h6>
                        <ul id="errorSuggestions" class="small ps-3 mb-0">
                            <li>Check the automation logs for detailed error information</li>
                            <li>Verify your ClassWallet credentials are correct</li>
                            <li>Try the submission again</li>
                        </ul>
                    </div>

                    <!-- Log Link -->
                    <div class="alert alert-info small mb-0">
                        <strong>Need more details?</strong> View the full error in the <a href="/manage-logs" class="alert-link">Automation Logs</a> page.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <a href="/manage-logs" class="btn btn-info" onclick="errorModalClosed()">View Logs</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Make students data available to app.js
        const studentsData = {{ students | tojson }};

        // Make category configurations available to app.js for file requirement validation
        const expenseCategories = {{ expense_categories | tojson }};
        const directPayCategories = {{ direct_pay_categories | tojson }};

        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        /**
         * Display error modal with detailed error message and suggestions
         * @param {string} errorMessage - The main error message to display
         * @param {string} errorCode - Optional error code for context-specific suggestions
         */
        function showErrorModal(errorMessage, errorCode = null) {
            const errorMessageEl = document.getElementById('errorMessage');
            const errorSuggestionsEl = document.getElementById('errorSuggestions');

            // Set the main error message
            errorMessageEl.textContent = errorMessage || 'An unexpected error occurred. Please try again.';

            // Clear and populate suggestions based on error code
            errorSuggestionsEl.innerHTML = '';
            let suggestions = [];

            switch (errorCode) {
                case 'CREDENTIALS_ERROR':
                    suggestions = [
                        'Configure your ClassWallet credentials in <strong>Settings ‚Üí ESA Credentials</strong>',
                        'Ensure your email and password are correct',
                        'Try the submission again'
                    ];
                    break;
                case 'LOGIN_ERROR':
                    suggestions = [
                        'Verify your ClassWallet email and password in <strong>Settings ‚Üí ESA Credentials</strong>',
                        'Ensure ClassWallet is not blocking your login attempt',
                        'Try logging in to ClassWallet manually in a browser to verify credentials',
                        'Try the submission again'
                    ];
                    break;
                case 'AUTOMATION_ERROR':
                    suggestions = [
                        'Ensure you have Chrome browser installed and accessible',
                        'Check that no other instances of the app are running',
                        'Try the submission again'
                    ];
                    break;
                case 'SUBMISSION_ERROR':
                    suggestions = [
                        'Review the error details above for specific guidance',
                        'Check the <strong>Automation Logs</strong> for detailed technical information',
                        'Verify all required fields are filled in correctly',
                        'Try the submission again'
                    ];
                    break;
                case 'NETWORK_ERROR':
                    suggestions = [
                        'Check your internet connection',
                        'Ensure the application server is running (try reloading the page)',
                        'Try the submission again'
                    ];
                    break;
                default:
                    suggestions = [
                        'Check the automation logs for detailed error information',
                        'Verify your ClassWallet credentials are correct',
                        'Try the submission again'
                    ];
            }

            // Add suggestions to the list
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.innerHTML = suggestion;
                errorSuggestionsEl.appendChild(li);
            });

            // Show the error modal
            const errorModal = new bootstrap.Modal(document.getElementById('errorModal'), {
                backdrop: 'static',
                keyboard: false
            });
            errorModal.show();
        }

        /**
         * Callback when error modal is closed (via View Logs button)
         */
        function errorModalClosed() {
            // Modal will close automatically when clicking View Logs button
            // This function can be used for any cleanup if needed
        }

        // Store split files temporarily
        let currentSplitFiles = [];
        let selectedSplitFiles = [];
        let currentSplitFileType = null; // Track which file type triggered the split

        function autoDetectAndSplitPdf(fileInput, fileType) {
            const file = fileInput.files[0];

            console.log('=== autoDetectAndSplitPdf DEBUG ===');
            console.log('  fileType parameter:', fileType);
            console.log('  file:', file ? `${file.name} (${file.type})` : 'NO FILE');
            console.log('  file.type.includes("pdf"):', file && file.type.includes('pdf'));

            if (!file || !file.type.includes('pdf')) {
                console.log('  Not a PDF, returning false');
                return false; // Not a PDF, handle normally
            }

            // It's a PDF - try to split it
            currentSplitFileType = fileType;
            console.log('  Setting currentSplitFileType:', currentSplitFileType);
            uploadAndSplitPdfFile(file);
            return true;
        }

        function uploadAndSplitPdfFile(file) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Uploading...</span></div> Uploading and splitting PDF...';
            statusDiv.style.display = 'block';

            console.log('=== uploadAndSplitPdfFile DEBUG ===');
            console.log('  Uploading file:', file.name);
            console.log('  currentSplitFileType:', currentSplitFileType);

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/pdf/split', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('  Response status:', response.status);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log('  API Response:', data);
                if (data.success) {
                    currentSplitFiles = data.files || [];
                    console.log('  Split files received:', currentSplitFiles);
                    console.log('  Number of split files:', currentSplitFiles.length);
                    if (currentSplitFiles.length > 1) {
                        // Multiple pages - show modal to select
                        selectedSplitFiles = [];
                        console.log('  Multiple pages detected, showing modal');
                        displaySplitFilesResults();
                        const modal = new bootstrap.Modal(document.getElementById('pdfSplitterModal'));
                        modal.show();
                    } else {
                        // Single page - just add it normally
                        console.log('  Single page, adding directly');
                        addSingleFileToForm(file);
                    }
                } else {
                    console.error('  API error:', data.error);
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                console.error('  Fetch error:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger">Error uploading PDF: ${error.message}</div>`;
            });
        }

        function addSingleFileToForm(file) {
            if (currentSplitFileType) {
                // Add single-page PDF directly
                if (!selectedFiles[currentSplitFileType]) {
                    selectedFiles[currentSplitFileType] = [];
                }
                selectedFiles[currentSplitFileType].push({
                    name: file.name,
                    path: '', // Single page doesn't need path
                    size: file.size
                });
                updateSelectedFilesDisplay();

                // Re-validate the form since file was added
                if (typeof validateForm === 'function') {
                    validateForm();
                }

                currentSplitFileType = null;
            }
        }

        function uploadAndSplitPdf() {
            const fileInput = document.getElementById('pdfFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a PDF file');
                return;
            }

            if (!file.type.includes('pdf')) {
                alert('Please select a valid PDF file');
                return;
            }

            uploadAndSplitPdfFile(file);

            const uploadBtn = document.getElementById('uploadPdfBtn');
            uploadBtn.disabled = true;
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Uploading...</span></div> Uploading and splitting PDF...';
            statusDiv.style.display = 'block';

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/pdf/split', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    currentSplitFiles = data.files || [];
                    selectedSplitFiles = [];
                    displaySplitFilesResults();
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Unknown error'}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                statusDiv.innerHTML = `<div class="alert alert-danger">Error uploading PDF: ${error.message}</div>`;
            })
            .finally(() => {
                uploadBtn.disabled = false;
            });
        }

        function displaySplitFilesResults() {
            const uploadSection = document.getElementById('uploadSection');
            const resultsSection = document.getElementById('resultsSection');
            const splitCountSpan = document.getElementById('splitCount');
            const splitFilesList = document.getElementById('splitFilesList');

            console.log('=== displaySplitFilesResults DEBUG ===');
            console.log('  currentSplitFiles:', currentSplitFiles);
            console.log('  Number of files:', currentSplitFiles.length);

            uploadSection.style.display = 'none';
            resultsSection.style.display = 'block';
            splitCountSpan.textContent = `${currentSplitFiles.length} page${currentSplitFiles.length !== 1 ? 's' : ''} created`;

            splitFilesList.innerHTML = currentSplitFiles.map((file, index) => `
                <div class="form-check mb-3 p-2" style="background-color: #f8f9fa; border-radius: 4px;">
                    <input class="form-check-input split-file-checkbox" type="checkbox" value="${file.filename}" id="splitFile${index}" data-filepath="${file.path}" checked>
                    <label class="form-check-label ms-2" for="splitFile${index}">
                        <strong>${file.filename}</strong><br>
                        <small class="text-muted">Page ${file.page_num} of ${file.total_pages}</small>
                    </label>
                </div>
            `).join('');

            console.log('  Created HTML with', currentSplitFiles.length, 'checkboxes');

            document.querySelectorAll('.split-file-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateSplitFileSelection();
                });
            });

            // Pre-select all pages by default
            console.log('  Calling updateSplitFileSelection()');
            updateSplitFileSelection();
        }

        function updateSplitFileSelection() {
            selectedSplitFiles = [];

            document.querySelectorAll('.split-file-checkbox').forEach((checkbox) => {
                if (checkbox.checked) {
                    selectedSplitFiles.push({
                        filename: checkbox.value,
                        path: checkbox.dataset.filepath
                    });
                }
            });

            console.log('=== updateSplitFileSelection DEBUG ===');
            console.log('  selectedSplitFiles:', selectedSplitFiles);
            console.log('  Number selected:', selectedSplitFiles.length);

            document.getElementById('addSelectedSplitFilesBtn').style.display = selectedSplitFiles.length > 0 ? 'block' : 'none';
        }

        function addSelectedSplitFilesToForm() {
            if (selectedSplitFiles.length === 0) {
                alert('Please select at least one file');
                return;
            }

            // Add selected files to the form - they all go to the file type that was clicked
            const fileType = currentSplitFileType || 'other';
            console.log('=== addSelectedSplitFilesToForm DEBUG START ===');
            console.log('  currentSplitFileType:', currentSplitFileType);
            console.log('  fileType being used:', fileType);
            console.log('  Number of selected split files:', selectedSplitFiles.length);
            console.log('  Selected split files:', selectedSplitFiles);
            console.log('  selectedFiles BEFORE adding:', JSON.stringify(selectedFiles, null, 2));
            console.log('  typeof selectedFiles:', typeof selectedFiles);
            console.log('  selectedFiles is null/undefined?:', selectedFiles === null || selectedFiles === undefined);

            if (!selectedFiles) {
                console.error('ERROR: selectedFiles is not defined! This is a critical issue.');
                console.log('Attempting to initialize selectedFiles = {}');
                window.selectedFiles = {};
            }

            selectedSplitFiles.forEach((file, index) => {
                console.log(`  Adding file ${index + 1}:`, file);
                if (!selectedFiles[fileType]) {
                    console.log(`    Creating array for fileType "${fileType}"`);
                    selectedFiles[fileType] = [];
                } else if (!Array.isArray(selectedFiles[fileType])) {
                    console.log(`    Converting existing value to array for fileType "${fileType}"`);
                    selectedFiles[fileType] = [selectedFiles[fileType]];
                }
                selectedFiles[fileType].push({
                    name: file.filename,
                    path: file.path,
                    size: 0
                });
                console.log(`    After adding file ${index + 1}, selectedFiles[${fileType}]:`, selectedFiles[fileType]);
            });

            console.log('  selectedFiles AFTER adding:', JSON.stringify(selectedFiles, null, 2));
            console.log('  Object.keys(selectedFiles):', Object.keys(selectedFiles));
            console.log('=== addSelectedSplitFilesToForm DEBUG END ===');

            // Update the visual display of selected files
            updateSelectedFilesDisplay();

            // Re-validate the form since files were added
            if (typeof validateForm === 'function') {
                console.log('Calling validateForm()...');
                validateForm();
            } else {
                console.error('ERROR: validateForm is not a function!');
            }

            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('pdfSplitterModal'));
            modal.hide();

            // Reset the modal for next use
            document.getElementById('pdfFileInput').value = '';
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            alert(`‚úì Added ${selectedSplitFiles.length} file${selectedSplitFiles.length !== 1 ? 's' : ''} to your submission!`);
        }

        function updateSelectedFilesDisplay() {
            const summaryDiv = document.getElementById('selectedFilesSummary');
            const displayDiv = document.getElementById('selectedFilesDisplay');

            // Count all selected files with their types
            let totalFiles = 0;
            let filesWithTypes = [];
            Object.keys(selectedFiles).forEach(fileType => {
                if (selectedFiles[fileType] && Array.isArray(selectedFiles[fileType])) {
                    selectedFiles[fileType].forEach(file => {
                        totalFiles++;
                        filesWithTypes.push({
                            name: file.name || file.path,
                            type: fileType
                        });
                    });
                }
            });

            if (totalFiles === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            // Display the files with their types
            displayDiv.innerHTML = filesWithTypes.map(item => `
                <div class="badge bg-success me-2 mb-2">
                    üìÑ ${item.name}
                    <span class="badge bg-light text-dark ms-2">${item.type}</span>
                </div>
            `).join('');

            summaryDiv.style.display = 'block';
        }

        /**
         * Load and display recent submissions
         * Made global so it can be called from app.js after submission completes
         */
        window.loadRecentSubmissions = function loadRecentSubmissions() {
            fetch('/api/submission-history?limit=5')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.submissions && data.submissions.length > 0) {
                        displayRecentSubmissions(data.submissions);
                    } else {
                        document.getElementById('recentSubmissionsList').innerHTML = `
                            <div class="p-3 text-center text-muted">
                                <small>No submissions yet</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error loading recent submissions:', error);
                });
        };

        // Load recent submissions sidebar (must be after function is defined)
        document.addEventListener('DOMContentLoaded', window.loadRecentSubmissions);

        function displayRecentSubmissions(submissions) {
            const list = document.getElementById('recentSubmissionsList');
            list.innerHTML = submissions.map((submission, index) => {
                const date = new Date(submission.logged_at);
                const formattedDate = date.toLocaleDateString();
                const student = submission.student || 'N/A';
                const vendor = submission.store_name || submission.vendor_name || 'N/A';
                const amount = parseFloat(submission.amount || 0).toFixed(2);

                return `
                    <a href="#" class="list-group-item list-group-item-action" onclick="showRecentSubmissionDetails(${index}); return false;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1" style="font-size: 0.9rem;">${student}</h6>
                                <small class="text-muted">${vendor}</small>
                            </div>
                            <span class="badge bg-success">$${amount}</span>
                        </div>
                        <small class="text-muted d-block mt-1">${formattedDate}</small>
                    </a>
                `;
            }).join('');
        }

        function showRecentSubmissionDetails(index) {
            fetch('/api/submission-history?limit=5')
                .then(response => response.json())
                .then(data => {
                    if (data.submissions && data.submissions[index]) {
                        const submission = data.submissions[index];
                        const date = new Date(submission.logged_at);
                        const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

                        let html = `
                            <div class="submission-details">
                                <div class="row mb-3">
                                    <div class="col-6"><strong>Date:</strong></div>
                                    <div class="col-6 text-end">${formattedDate}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6"><strong>Student:</strong></div>
                                    <div class="col-6 text-end">${submission.student || 'N/A'}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6"><strong>${submission.type === 'direct_pay' ? 'Vendor' : 'Store'}:</strong></div>
                                    <div class="col-6 text-end">${submission.store_name || submission.vendor_name || 'N/A'}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6"><strong>Amount:</strong></div>
                                    <div class="col-6 text-end">$${parseFloat(submission.amount || 0).toFixed(2)}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6"><strong>Category:</strong></div>
                                    <div class="col-6 text-end" style="font-size: 0.85rem;">${submission.expense_category || submission.category || 'N/A'}</div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-6"><strong>PO #:</strong></div>
                                    <div class="col-6 text-end">${submission.po_number || 'N/A'}</div>
                                </div>
                                <div class="row">
                                    <div class="col-6"><strong>Status:</strong></div>
                                    <div class="col-6 text-end">
                                        <span class="badge ${submission.success !== false ? 'bg-success' : 'bg-danger'}">
                                            ${submission.success !== false ? 'Success' : 'Failed'}
                                        </span>
                                    </div>
                                </div>
                        `;

                        if (submission.comment) {
                            html += `
                                <hr>
                                <div class="mb-3">
                                    <strong>Comment:</strong>
                                    <p class="mb-0 mt-2 text-muted" style="font-size: 0.85rem;">${submission.comment}</p>
                                </div>
                            `;
                        }

                        html += '</div>';
                        document.getElementById('submissionDetailsContent').innerHTML = html;
                        new bootstrap.Modal(document.getElementById('submissionDetailsModal')).show();
                    }
                });
        }
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
